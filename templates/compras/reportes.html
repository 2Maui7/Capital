{% extends 'base.html' %}

{% block title %}Reportes de Compras - Imprenta Capital{% endblock %}
{% block page_title %}Reportes de Compras{% endblock %}
{% block page_subtitle %}Resumen y analítica básica{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <i class="bi bi-file-earmark-text me-2"></i>Resumen de Compras
    </div>
    <a href="{% url 'core:compras_lista' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Volver a Compras
    </a>
  </div>
  <div class="card-body">
    <form method="get" class="mb-4">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label" for="start_date">Desde</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}" />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="end_date">Hasta</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}" />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="estado">Estado</label>
          <select id="estado" name="estado" class="form-select">
            <option value="" {% if not estado %}selected{% endif %}>Todos</option>
            <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="ordenado" {% if estado == 'ordenado' %}selected{% endif %}>Ordenado</option>
            <option value="recibido" {% if estado == 'recibido' %}selected{% endif %}>Recibido</option>
            <option value="cancelado" {% if estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
          </select>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button type="submit" name="export" value="pdf" class="btn btn-outline-danger">
          <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
        </button>
      </div>
    </form>

    <div class="row g-3">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="text-muted small">Total</div>
            <div class="fs-4 fw-bold">{{ resumen.total }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="text-muted small">Pendientes</div>
            <div class="fs-4 fw-bold">{{ resumen.pendientes }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="text-muted small">Ordenadas</div>
            <div class="fs-4 fw-bold">{{ resumen.ordenadas }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="text-muted small">Recibidas</div>
            <div class="fs-4 fw-bold">{{ resumen.recibidas }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="text-muted small">Costo total</div>
            <div class="fs-5 fw-bold">Bs. {{ resumen.costo_total }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const form = document.querySelector('form[method="get"]');
    if (!form) return;
    const start = document.getElementById('start_date');
    const end = document.getElementById('end_date');
    const estado = document.getElementById('estado');

    let t;
    function debounceSubmit(){
      if (t) clearTimeout(t);
      t = setTimeout(() => form.submit(), 300);
    }

    if (start) start.addEventListener('change', debounceSubmit);
    if (end) end.addEventListener('change', debounceSubmit);
    if (estado) estado.addEventListener('change', () => form.submit());
  })();
</script>
{% endblock %}
